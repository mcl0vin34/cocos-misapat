{"version":3,"sources":["file:///C:/GitHub/cocos-misapat/assets/scripts/SocketManager.ts"],"names":["_decorator","Component","Label","Color","ProgressBar","IncomeManager","PassiveIncomeModal","ccclass","property","SocketManager","socket","userId","userData","maxEnergy","currentEnergy","currentBoosts","maxBoosts","currentCoins","instance","_instance","console","error","onLoad","warn","node","destroy","start","coinsLabel","energyProgressBar","energyValueLabel","messagesLabel","boostsLabel","incomeManager","incomeManagerNode","scene","getChildByName","getComponent","initializeUser","showUserInfo","onDestroy","disconnect","loadTelegramSDK","Promise","resolve","reject","window","Telegram","script","document","createElement","src","onload","onerror","Error","head","appendChild","tg","WebApp","log","initDataUnsafe","ready","user","id","username","first_name","last_name","language_code","is_premium","photo_url","full_name","useMockData","createOrUpdateUser","fetchInitialData","autoConnect","checkPassiveIncome","start_param","startParam","startsWith","referrerId","replace","referralId","toString","response","fetch","method","headers","body","JSON","stringify","ok","data","json","message","queryParams","URLSearchParams","postResponse","statusText","io","transports","secure","rejectUnauthorized","on","emit","showMessage","energy_left","undefined","updateEnergy","Math","round","boosts_left","updateBoosts","coins","updateCoins","newEnergyValue","status","fetchTotalCoins","string","toLocaleString","income","fetchPassiveIncome","passiveIncomeModal","show","errorText","text","passive_income_earned","boostsLeft","max","min","progress","active","type","color","getCurrentEnergy","getCurrentBoosts","activateBoost","connected","onTap","getUserId","setUserId"],"mappings":"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","sourcesContent":["// cocos-project/assets/scripts/SocketManager.ts\r\n\r\nimport { _decorator, Component, Label, Color, ProgressBar, Node } from \"cc\";\r\nimport { IncomeManager } from \"./IncomeManager\";\r\nimport { PassiveIncomeModal } from \"./PassiveIncomeModal\";\r\ndeclare const io: any;\r\n\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass(\"SocketManager\")\r\nexport class SocketManager extends Component {\r\n  private static _instance: SocketManager = null;\r\n\r\n  public static get instance(): SocketManager {\r\n    if (!SocketManager._instance) {\r\n      console.error(\r\n        \"SocketManager не инициализирован. Убедитесь, что он добавлен на ноду в сцене.\"\r\n      );\r\n    }\r\n    return SocketManager._instance;\r\n  }\r\n\r\n  @property(Label)\r\n  coinsLabel: Label = null;\r\n\r\n  @property(ProgressBar)\r\n  energyProgressBar: ProgressBar = null;\r\n\r\n  @property(Label)\r\n  energyValueLabel: Label = null;\r\n\r\n  @property(Label)\r\n  messagesLabel: Label = null;\r\n\r\n  @property(Label)\r\n  boostsLabel: Label = null;\r\n\r\n  @property(IncomeManager)\r\n  incomeManager: IncomeManager = null;\r\n\r\n  @property(PassiveIncomeModal)\r\n  passiveIncomeModal: PassiveIncomeModal = null;\r\n\r\n  private socket: any = null;\r\n  private userId: number = null;\r\n  private userData: any = null;\r\n  private maxEnergy: number = 2000;\r\n  private currentEnergy: number = 0;\r\n  private currentBoosts: number = 0;\r\n  private maxBoosts: number = 6;\r\n  private currentCoins: number = 0;\r\n\r\n  onLoad() {\r\n    if (SocketManager._instance && SocketManager._instance !== this) {\r\n      console.warn(\"SocketManager уже существует. Удаление дубликата.\");\r\n      this.node.destroy();\r\n      return;\r\n    }\r\n    SocketManager._instance = this;\r\n  }\r\n\r\n  start() {\r\n    if (\r\n      !this.coinsLabel ||\r\n      !this.energyProgressBar ||\r\n      !this.energyValueLabel ||\r\n      !this.messagesLabel ||\r\n      !this.boostsLabel\r\n    ) {\r\n      console.error(\"Не все необходимые компоненты назначены в SocketManager.\");\r\n      return;\r\n    }\r\n\r\n    if (!this.incomeManager) {\r\n      const incomeManagerNode =\r\n        this.node.scene.getChildByName(\"IncomeManagerNode\");\r\n      if (incomeManagerNode) {\r\n        this.incomeManager = incomeManagerNode.getComponent(IncomeManager);\r\n      } else {\r\n        console.warn(\"IncomeManager не найден в сцене.\");\r\n      }\r\n    }\r\n\r\n    this.initializeUser();\r\n\r\n    this.showUserInfo(false);\r\n  }\r\n\r\n  onDestroy() {\r\n    if (this.socket) {\r\n      this.socket.disconnect();\r\n    }\r\n    if (SocketManager._instance === this) {\r\n      SocketManager._instance = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Динамически загружает Telegram Web Apps SDK\r\n   */\r\n  private loadTelegramSDK(): Promise<void> {\r\n    return new Promise((resolve, reject) => {\r\n      if ((window as any).Telegram) {\r\n        resolve();\r\n        return;\r\n      }\r\n\r\n      const script = document.createElement(\"script\");\r\n      script.src = \"https://telegram.org/js/telegram-web-app.js\";\r\n      script.onload = () => {\r\n        resolve();\r\n      };\r\n      script.onerror = () => {\r\n        reject(new Error(\"Не удалось загрузить Telegram Web Apps SDK.\"));\r\n      };\r\n      document.head.appendChild(script);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Инициализирует пользователя, получая данные из Telegram WebApp API или используя моковые данные\r\n   */\r\n  async initializeUser() {\r\n    try {\r\n      await this.loadTelegramSDK();\r\n\r\n      const tg = (window as any).Telegram?.WebApp;\r\n\r\n      if (tg) {\r\n        console.log(\"Telegram WebApp API доступен\");\r\n        console.log(tg.initDataUnsafe);\r\n\r\n        // Ждём, пока Telegram WebApp будет готов\r\n        await new Promise<void>((resolve) => {\r\n          tg.ready();\r\n          resolve();\r\n        });\r\n\r\n        console.log(\"tg.initDataUnsafe после готовности:\", tg.initDataUnsafe);\r\n\r\n        if (tg.initDataUnsafe?.user?.id) {\r\n          const userData = {\r\n            id: tg.initDataUnsafe.user.id,\r\n            username: tg.initDataUnsafe.user.username,\r\n            first_name: tg.initDataUnsafe.user.first_name,\r\n            last_name: tg.initDataUnsafe.user.last_name || \"\",\r\n            language_code: tg.initDataUnsafe.user.language_code || \"\",\r\n            is_premium: tg.initDataUnsafe.user.is_premium || false,\r\n            photo_url: tg.initDataUnsafe.user.photo_url || \"\",\r\n            full_name: `${tg.initDataUnsafe.user.first_name} ${\r\n              tg.initDataUnsafe.user.last_name || \"\"\r\n            }`,\r\n          };\r\n\r\n          console.log(\"Данные пользователя Telegram:\", userData);\r\n\r\n          this.userId = userData.id;\r\n          this.userData = userData;\r\n        } else {\r\n          console.warn(\"Данные пользователя не найдены в tg.initDataUnsafe.\");\r\n          this.useMockData();\r\n        }\r\n      } else {\r\n        console.warn(\"Telegram WebApp недоступен. Используем моковые данные.\");\r\n        this.useMockData();\r\n      }\r\n\r\n      // Продолжаем инициализацию\r\n      await this.createOrUpdateUser(this.userData);\r\n      await this.fetchInitialData();\r\n      this.autoConnect();\r\n      this.showUserInfo(true);\r\n      this.checkPassiveIncome();\r\n\r\n      // Обработка реферальных параметров\r\n      if (tg && tg.initDataUnsafe?.start_param) {\r\n        const startParam = tg.initDataUnsafe.start_param;\r\n        console.log(\"start_param:\", startParam);\r\n\r\n        if (startParam.startsWith(\"refId\")) {\r\n          const referrerId = startParam.replace(\"refId\", \"\");\r\n          const referralId = this.userId;\r\n\r\n          if (\r\n            referralId &&\r\n            referrerId &&\r\n            referralId.toString() !== referrerId\r\n          ) {\r\n            try {\r\n              const response = await fetch(\r\n                `https://dev.simatap.ru/api/referrals?referrer_id=${referrerId}&referral_id=${referralId}`,\r\n                {\r\n                  method: \"POST\",\r\n                  headers: {\r\n                    \"Content-Type\": \"application/json\",\r\n                  },\r\n                  body: JSON.stringify({}),\r\n                }\r\n              );\r\n\r\n              if (response.ok) {\r\n                console.log(\"Реферал успешно зарегистрирован.\");\r\n              } else {\r\n                const data = await response.json();\r\n                if (data.message === \"Такая запись о реферале уже существует\") {\r\n                  console.log(\"Реферал уже существует.\");\r\n                } else {\r\n                  console.error(\r\n                    \"Ошибка при регистрации реферала:\",\r\n                    data.message\r\n                  );\r\n                }\r\n              }\r\n            } catch (error) {\r\n              console.error(\"Ошибка при регистрации реферала:\", error);\r\n            }\r\n          }\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Ошибка при инициализации пользователя:\", error);\r\n    }\r\n  }\r\n\r\n  private useMockData() {\r\n    const userData = {\r\n      id: 230230230,\r\n      username: \"230 bro's\",\r\n      first_name: \"madesta\",\r\n      last_name: \"\",\r\n      language_code: \"en\",\r\n      is_premium: false,\r\n      photo_url: \"\",\r\n      full_name: \"Test User\",\r\n    };\r\n    this.userId = userData.id;\r\n    this.userData = userData;\r\n  }\r\n\r\n  /**\r\n   * Создает или обновляет пользователя на сервере\r\n   * @param userData Данные пользователя\r\n   */\r\n  async createOrUpdateUser(userData: any) {\r\n    try {\r\n      const queryParams = new URLSearchParams({\r\n        id: userData.id.toString(),\r\n        username: userData.username || \"\",\r\n        first_name: userData.first_name || \"\",\r\n        last_name: userData.last_name || \"\",\r\n      });\r\n\r\n      const postResponse = await fetch(\r\n        `https://dev.simatap.ru/api/users?${queryParams.toString()}`,\r\n        {\r\n          method: \"POST\",\r\n          headers: {\r\n            \"Content-Type\": \"application/json\",\r\n          },\r\n          body: JSON.stringify({}),\r\n        }\r\n      );\r\n\r\n      if (!postResponse.ok) {\r\n        throw new Error(\r\n          `Ошибка при отправке POST запроса: ${postResponse.statusText}`\r\n        );\r\n      }\r\n\r\n      console.log(\"Пользователь успешно создан или обновлен.\");\r\n    } catch (error) {\r\n      console.warn(\"Ошибка при создании или обновлении пользователя.\", error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Автоматически подключается к серверу Socket.IO с userId\r\n   */\r\n  autoConnect() {\r\n    try {\r\n      this.socket = io(\"https://dev.simatap.ru\", {\r\n        transports: [\"websocket\"],\r\n        secure: true,\r\n        rejectUnauthorized: false,\r\n      });\r\n\r\n      this.socket.on(\"connect\", () => {\r\n        this.socket.emit(\"register\", { userId: this.userId });\r\n        this.showUserInfo(true);\r\n      });\r\n\r\n      this.socket.on(\"disconnect\", () => {\r\n        this.showMessage(\"Отключено от сервера.\", \"danger\");\r\n        this.showUserInfo(false);\r\n      });\r\n\r\n      this.socket.on(\"energyUpdated\", (data: any) => {\r\n        if (data.energy_left !== undefined) {\r\n          this.updateEnergy(Math.round(data.energy_left));\r\n        } else {\r\n          console.warn(\r\n            \"energyUpdated event received, but energy_left is undefined.\"\r\n          );\r\n        }\r\n      });\r\n\r\n      // Обработчик обновления количества бустов\r\n      this.socket.on(\"boostsUpdated\", (data: any) => {\r\n        console.log(\"Received boostsUpdated event:\", data);\r\n        if (data.boosts_left !== undefined) {\r\n          this.updateBoosts(data.boosts_left);\r\n        } else {\r\n          console.warn(\r\n            \"boostsUpdated event received, but boosts_left is undefined.\"\r\n          );\r\n        }\r\n      });\r\n\r\n      // Обработчик события обновления монет\r\n      this.socket.on(\"coinsUpdated\", (data: any) => {\r\n        if (data.coins !== undefined) {\r\n          this.updateCoins(Math.round(data.coins));\r\n        } else {\r\n          console.warn(\"coinsUpdated event received, but coins is undefined.\");\r\n        }\r\n      });\r\n\r\n      this.socket.on(\"tapError\", (data: any) => {\r\n        this.showMessage(data.message, \"warning\");\r\n      });\r\n\r\n      this.socket.on(\"registrationError\", (data: any) => {\r\n        this.showMessage(data.message, \"danger\");\r\n        this.showUserInfo(false);\r\n      });\r\n\r\n      this.socket.on(\"connect_error\", (error: any) => {\r\n        this.showMessage(\"Ошибка подключения к серверу.\", \"danger\");\r\n      });\r\n\r\n      // Обработчик ответа на активацию буста\r\n      this.socket.on(\"boostActivated\", (data: any) => {\r\n        console.log(\"Boost activation response:\", data);\r\n        if (data.newEnergyValue !== undefined) {\r\n          this.updateEnergy(Math.round(data.newEnergyValue));\r\n        }\r\n      });\r\n\r\n      // Обработчик ошибки при активации буста\r\n      this.socket.on(\"boostError\", (data: any) => {\r\n        console.error(\"Ошибка активации буста:\", data.message);\r\n      });\r\n    } catch (error) {\r\n      this.showMessage(\"Ошибка подключения к серверу.\", \"danger\");\r\n      console.error(\"Socket connection error:\", error);\r\n    }\r\n  }\r\n\r\n  async fetchInitialData() {\r\n    try {\r\n      const response = await fetch(\r\n        `https://dev.simatap.ru/api/users/${this.userId}`\r\n      );\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`);\r\n      }\r\n      const data = await response.json();\r\n\r\n      console.log(\"API response:\", data);\r\n\r\n      if (data.energy_left !== undefined) {\r\n        this.updateEnergy(Math.round(data.energy_left));\r\n        console.log(`Initial energy fetched: ${Math.round(data.energy_left)}`);\r\n      } else {\r\n        console.warn(\"Energy data not found in API response.\");\r\n      }\r\n\r\n      if (data.boosts_left !== undefined) {\r\n        this.updateBoosts(data.boosts_left);\r\n        console.log(`Initial boosts fetched: ${data.boosts_left}`);\r\n      } else {\r\n        console.warn(\"Boosts data not found in API response.\");\r\n      }\r\n\r\n      await this.fetchTotalCoins();\r\n    } catch (error) {\r\n      console.error(\"Error fetching initial data:\", error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Получает общее количество монет пользователя\r\n   */\r\n  async fetchTotalCoins() {\r\n    try {\r\n      const response = await fetch(\r\n        `https://dev.simatap.ru/api/totalCoins/${this.userId}`\r\n      );\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`);\r\n      }\r\n      const data = await response.json();\r\n\r\n      if (data.coins !== undefined) {\r\n        this.updateCoins(Math.round(data.coins));\r\n        console.log(`Total coins fetched: ${Math.round(data.coins)}`);\r\n      } else {\r\n        console.warn(\"Coins data not found in API response.\");\r\n      }\r\n    } catch (error) {\r\n      console.warn(\r\n        \"Ошибка при получении количества монет. Используем значение по умолчанию 0.\",\r\n        error\r\n      );\r\n      this.updateCoins(0);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Обновляет количество монет и соответствующую метку.\r\n   * @param coins Новое количество монет.\r\n   */\r\n  updateCoins(coins: number) {\r\n    this.currentCoins = coins;\r\n    if (this.coinsLabel) {\r\n      this.coinsLabel.string = this.currentCoins.toLocaleString();\r\n    } else {\r\n      console.warn(\"coinsLabel не назначен в SocketManager.\");\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Проверяет и обрабатывает пассивный доход\r\n   */\r\n  async checkPassiveIncome() {\r\n    const income = await this.fetchPassiveIncome();\r\n    if (income > 0) {\r\n      if (this.passiveIncomeModal) {\r\n        this.passiveIncomeModal.show(income);\r\n      } else {\r\n        console.warn(\"PassiveIncomeModal не назначен в SocketManager.\");\r\n      }\r\n\r\n      this.currentCoins += income;\r\n      this.updateCoins(this.currentCoins);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Получает пассивный доход с сервера и возвращает его\r\n   */\r\n  async fetchPassiveIncome(): Promise<number> {\r\n    try {\r\n      const response = await fetch(\r\n        `https://dev.simatap.ru/api/passiveIncome?userId=${this.userId}`\r\n      );\r\n      if (!response.ok) {\r\n        const errorText = await response.text();\r\n        throw new Error(\r\n          `HTTP error! status: ${response.status}, response: ${errorText}`\r\n        );\r\n      }\r\n      const data = await response.json();\r\n\r\n      console.log(\"Passive income API response:\", data);\r\n\r\n      if (\"passive_income_earned\" in data) {\r\n        const income = Math.round(data.passive_income_earned);\r\n        console.log(`Пассивный доход получен: ${income}`);\r\n        return income;\r\n      } else if (\"message\" in data) {\r\n        console.log(`Сообщение от сервера: ${data.message}`);\r\n        return 0;\r\n      } else {\r\n        console.warn(\"Неизвестный формат ответа от сервера:\", data);\r\n        return 0;\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Ошибка при получении пассивного дохода:\", error);\r\n      return 0;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Обновляет количество бустов и соответствующую метку.\r\n   * @param boostsLeft Текущее количество оставшихся бустов.\r\n   */\r\n  updateBoosts(boostsLeft: number) {\r\n    this.currentBoosts = boostsLeft;\r\n    if (this.boostsLabel) {\r\n      this.boostsLabel.string = `${this.currentBoosts}/${this.maxBoosts}`;\r\n    } else {\r\n      console.warn(\"boostsLabel не назначен в SocketManager.\");\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Обновляет прогресс-бар энергии и текстовую метку.\r\n   * @param currentEnergy Текущее значение энергии.\r\n   */\r\n  updateEnergy(currentEnergy: number) {\r\n    currentEnergy = Math.round(\r\n      Math.max(0, Math.min(this.maxEnergy, currentEnergy))\r\n    );\r\n    this.currentEnergy = currentEnergy;\r\n\r\n    const progress = currentEnergy / this.maxEnergy;\r\n    this.energyProgressBar.progress = progress;\r\n\r\n    this.energyValueLabel.string = `${currentEnergy}/${this.maxEnergy}`;\r\n  }\r\n\r\n  /**\r\n   * Показывает или скрывает UserInfo\r\n   * @param show Показывать или скрывать\r\n   */\r\n  showUserInfo(show: boolean) {\r\n    if (\r\n      this.coinsLabel &&\r\n      this.energyProgressBar &&\r\n      this.energyValueLabel &&\r\n      this.boostsLabel\r\n    ) {\r\n      this.coinsLabel.node.active = show;\r\n      this.energyProgressBar.node.active = show;\r\n      this.energyValueLabel.node.active = show;\r\n      this.boostsLabel.node.active = show;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Отображает сообщение пользователю\r\n   * @param message Текст сообщения\r\n   * @param type Тип сообщения ('success', 'danger', 'warning', 'info')\r\n   */\r\n  showMessage(message: string, type: string = \"info\") {\r\n    if (this.messagesLabel) {\r\n      this.messagesLabel.string = message;\r\n      switch (type) {\r\n        case \"success\":\r\n          this.messagesLabel.node.color = new Color(0, 255, 0);\r\n          break;\r\n        case \"danger\":\r\n          this.messagesLabel.node.color = new Color(255, 0, 0);\r\n          break;\r\n        case \"warning\":\r\n          this.messagesLabel.node.color = new Color(255, 165, 0);\r\n          break;\r\n        default:\r\n          this.messagesLabel.node.color = new Color(255, 255, 255);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Возвращает текущее значение энергии\r\n   */\r\n  getCurrentEnergy(): number {\r\n    return this.currentEnergy;\r\n  }\r\n\r\n  /**\r\n   * Возвращает текущее количество бустов\r\n   */\r\n  getCurrentBoosts(): number {\r\n    return this.currentBoosts;\r\n  }\r\n\r\n  /**\r\n   * Активирует буст\r\n   */\r\n  activateBoost() {\r\n    if (!this.socket || !this.socket.connected || !this.userId) {\r\n      console.error(\r\n        \"Не удалось использовать буст: сокет не подключен или userId не установлен.\"\r\n      );\r\n      return;\r\n    }\r\n    this.socket.emit(\"useBoost\", { userId: this.userId });\r\n    console.log(\"Буст активирован.\");\r\n  }\r\n\r\n  /**\r\n   * Обработчик события \"tap\"\r\n   */\r\n  onTap() {\r\n    if (!this.userId) {\r\n      this.showMessage(\"Пользователь не подключен.\", \"danger\");\r\n      return;\r\n    }\r\n    if (this.currentEnergy < 13) {\r\n      this.showMessage(\"Не хватает энергии для тапа.\", \"warning\");\r\n      return;\r\n    }\r\n    if (this.socket && this.socket.connected) {\r\n      this.socket.emit(\"tap\", { userId: this.userId });\r\n      this.showMessage(\"Тап отправлен!\", \"info\");\r\n    } else {\r\n      this.showMessage(\"Соединение с сервером отсутствует.\", \"danger\");\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Получает текущий userId\r\n   */\r\n  public getUserId(): number {\r\n    return this.userId;\r\n  }\r\n\r\n  /**\r\n   * Устанавливает новый userId\r\n   * @param id Новый ID пользователя\r\n   */\r\n  public setUserId(id: number) {\r\n    this.userId = id;\r\n    if (this.socket && this.socket.connected) {\r\n      this.socket.emit(\"register\", { userId: this.userId });\r\n    }\r\n  }\r\n}\r\n"]}
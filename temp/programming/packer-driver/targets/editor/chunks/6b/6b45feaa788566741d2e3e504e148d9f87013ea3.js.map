{"version":3,"sources":["file:///C:/GitHub/cocos-misapat/assets/scripts/ReferralLinkManager.ts"],"names":["_decorator","Component","Node","Label","Vec3","Color","tween","SocketManager","ccclass","property","ReferralLinkManager","referralLink","initialPosition","start","copyLinkNode","console","error","inviteFriendNode","referralLinkLabel","copyNotificationLabel","generateReferralLink","on","EventType","TOUCH_END","onCopyLinkClicked","active","onInviteFriendClicked","node","position","clone","userId","instance","getUserId","log","string","color","setPosition","to","animationDuration","by","moveUpDistance","call","warn","navigator","clipboard","writeText","err","shareReferralLinkText","shareUrl","encodeURIComponent","tg","window","Telegram","WebApp","openTelegramLink","open"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, Label, Vec3, Color, tween } from \"cc\";\r\nimport { SocketManager } from \"./SocketManager\";\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass(\"ReferralLinkManager\")\r\nexport class ReferralLinkManager extends Component {\r\n  @property(Node)\r\n  copyLinkNode: Node = null;\r\n\r\n  @property(Node)\r\n  inviteFriendNode: Node = null;\r\n\r\n  @property(Label)\r\n  referralLinkLabel: Label = null;\r\n\r\n  @property(Label)\r\n  copyNotificationLabel: Label = null;\r\n\r\n  private referralLink: string = \"\";\r\n\r\n  @property\r\n  animationDuration: number = 1.5;\r\n\r\n  @property\r\n  moveUpDistance: number = 300;\r\n\r\n  private initialPosition: Vec3 = new Vec3();\r\n\r\n  start() {\r\n    if (!this.copyLinkNode) {\r\n      console.error(\"copyLinkNode не назначен в ReferralLinkManager.\");\r\n    }\r\n    if (!this.inviteFriendNode) {\r\n      console.error(\"inviteFriendNode не назначен в ReferralLinkManager.\");\r\n    }\r\n    if (!this.referralLinkLabel) {\r\n      console.error(\"referralLinkLabel не назначен в ReferralLinkManager.\");\r\n    }\r\n    if (!this.copyNotificationLabel) {\r\n      console.error(\"copyNotificationLabel не назначен в ReferralLinkManager.\");\r\n    }\r\n\r\n    // Генерируем реферальную ссылку при старте\r\n    this.generateReferralLink();\r\n\r\n    // Назначаем обработчики событий\r\n    if (this.copyLinkNode) {\r\n      this.copyLinkNode.on(\r\n        Node.EventType.TOUCH_END,\r\n        this.onCopyLinkClicked,\r\n        this\r\n      );\r\n      this.copyLinkNode.active = true;\r\n    }\r\n\r\n    if (this.inviteFriendNode) {\r\n      this.inviteFriendNode.on(\r\n        Node.EventType.TOUCH_END,\r\n        this.onInviteFriendClicked,\r\n        this\r\n      );\r\n    }\r\n\r\n    if (this.copyNotificationLabel) {\r\n      this.copyNotificationLabel.node.active = false;\r\n      this.initialPosition = this.copyNotificationLabel.node.position.clone();\r\n    }\r\n  }\r\n\r\n  generateReferralLink() {\r\n    const userId = SocketManager.instance?.getUserId() || 230230230; // Используйте реальный userId или моковые данные\r\n    console.log(\"User ID:\", userId);\r\n\r\n    if (!userId) {\r\n      console.error(\"userId не установлен.\");\r\n      return;\r\n    }\r\n\r\n    this.referralLink = `https://t.me/misapatStage_bot?startapp=refId${userId}`;\r\n    if (this.referralLinkLabel) {\r\n      this.referralLinkLabel.string = this.referralLink;\r\n    }\r\n    console.log(`Реферальная ссылка создана: ${this.referralLink}`);\r\n  }\r\n\r\n  async onCopyLinkClicked() {\r\n    console.log(\"onCopyLinkClicked called\");\r\n    if (this.copyNotificationLabel) {\r\n      this.copyNotificationLabel.node.active = true;\r\n      this.copyNotificationLabel.color = new Color(255, 255, 255, 255);\r\n      this.copyNotificationLabel.node.setPosition(this.initialPosition.clone());\r\n\r\n      tween(this.copyNotificationLabel)\r\n        .to(this.animationDuration, { color: new Color(255, 255, 255, 0) })\r\n        .start();\r\n\r\n      tween(this.copyNotificationLabel.node)\r\n        .by(this.animationDuration, {\r\n          position: new Vec3(0, this.moveUpDistance, 0),\r\n        })\r\n        .call(() => {\r\n          this.copyNotificationLabel.node.active = false;\r\n          this.copyNotificationLabel.color = new Color(255, 255, 255, 255);\r\n          this.copyNotificationLabel.node.setPosition(\r\n            this.initialPosition.clone()\r\n          );\r\n        })\r\n        .start();\r\n    }\r\n\r\n    if (!this.referralLink) {\r\n      console.warn(\"Реферальная ссылка не создана.\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      await navigator.clipboard.writeText(this.referralLink);\r\n      console.log(\"Реферальная ссылка скопирована в буфер обмена.\");\r\n    } catch (err) {\r\n      console.error(\"Не удалось скопировать ссылку: \", err);\r\n    }\r\n  }\r\n\r\n  onInviteFriendClicked() {\r\n    console.log(\"onInviteFriendClicked called\");\r\n    if (!this.referralLink) {\r\n      console.warn(\"Реферальная ссылка не создана.\");\r\n      return;\r\n    }\r\n\r\n    const shareReferralLinkText = \"Тапай и зарабатывай!\";\r\n    const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(\r\n      this.referralLink\r\n    )}&text=${encodeURIComponent(shareReferralLinkText)}`;\r\n\r\n    const tg = (window as any).Telegram?.WebApp;\r\n    if (tg && tg.openTelegramLink) {\r\n      console.log(\"Используем tg.openTelegramLink для открытия ссылки\");\r\n      tg.openTelegramLink(shareUrl);\r\n    } else {\r\n      console.warn(\r\n        \"Не удалось открыть Telegram для совместного использования.\"\r\n      );\r\n      // Попробуем открыть ссылку в браузере\r\n      window.open(shareUrl, \"_blank\");\r\n    }\r\n  }\r\n}\r\n"]}
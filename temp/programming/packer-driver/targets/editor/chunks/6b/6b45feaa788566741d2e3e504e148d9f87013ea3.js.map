{"version":3,"sources":["file:///C:/GitHub/cocos-misapat/assets/scripts/ReferralLinkManager.ts"],"names":["_decorator","Component","Node","Label","Vec3","Color","tween","sys","SocketManager","ccclass","property","ReferralLinkManager","referralLink","initialPosition","start","copyLinkNode","console","error","inviteFriendNode","referralLinkLabel","copyNotificationLabel","generateReferralLink","on","EventType","TOUCH_END","onCopyLinkClicked","active","onInviteFriendClicked","node","position","clone","generateLinkNode","onGenerateLinkClicked","instance","userId","getUserId","log","string","color","setPosition","to","animationDuration","by","moveUpDistance","call","warn","navigator","clipboard","writeText","err","tg","window","Telegram","WebApp","openTelegramLink","openURL"],"mappings":"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","sourcesContent":["// assets/scripts/Referral/ReferralLinkManager.ts\r\n\r\nimport {\r\n  _decorator,\r\n  Component,\r\n  Node,\r\n  Label,\r\n  Vec3,\r\n  Color,\r\n  tween,\r\n  sys,\r\n} from \"cc\";\r\nimport { SocketManager } from \"./SocketManager\";\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass(\"ReferralLinkManager\")\r\nexport class ReferralLinkManager extends Component {\r\n  @property(Node)\r\n  generateLinkNode: Node = null;\r\n\r\n  @property(Node)\r\n  copyLinkNode: Node = null;\r\n\r\n  @property(Node)\r\n  inviteFriendNode: Node = null;\r\n\r\n  @property(Label)\r\n  referralLinkLabel: Label = null;\r\n\r\n  @property(Label)\r\n  copyNotificationLabel: Label = null;\r\n\r\n  private referralLink: string = \"\";\r\n\r\n  @property\r\n  animationDuration: number = 1.5;\r\n\r\n  @property\r\n  moveUpDistance: number = 300;\r\n\r\n  private initialPosition: Vec3 = new Vec3();\r\n\r\n  start() {\r\n    if (!this.copyLinkNode) {\r\n      console.error(\"copyLinkNode не назначен в ReferralLinkManager.\");\r\n    }\r\n    if (!this.inviteFriendNode) {\r\n      console.error(\"inviteFriendNode не назначен в ReferralLinkManager.\");\r\n    }\r\n    if (!this.referralLinkLabel) {\r\n      console.error(\"referralLinkLabel не назначен в ReferralLinkManager.\");\r\n    }\r\n    if (!this.copyNotificationLabel) {\r\n      console.error(\"copyNotificationLabel не назначен в ReferralLinkManager.\");\r\n    }\r\n\r\n    // Генерируем реферальную ссылку при старте\r\n    this.generateReferralLink();\r\n\r\n    // Назначаем обработчики событий\r\n    if (this.copyLinkNode) {\r\n      this.copyLinkNode.on(\r\n        Node.EventType.TOUCH_END,\r\n        this.onCopyLinkClicked,\r\n        this\r\n      );\r\n      this.copyLinkNode.active = true;\r\n    }\r\n\r\n    if (this.inviteFriendNode) {\r\n      this.inviteFriendNode.on(\r\n        Node.EventType.TOUCH_END,\r\n        this.onInviteFriendClicked,\r\n        this\r\n      );\r\n    }\r\n\r\n    if (this.copyNotificationLabel) {\r\n      this.copyNotificationLabel.node.active = false;\r\n      this.initialPosition = this.copyNotificationLabel.node.position.clone();\r\n    }\r\n\r\n    if (this.generateLinkNode) {\r\n      this.generateLinkNode.on(\r\n        Node.EventType.TOUCH_END,\r\n        this.onGenerateLinkClicked,\r\n        this\r\n      );\r\n    }\r\n  }\r\n\r\n  generateReferralLink() {\r\n    if (!SocketManager.instance) {\r\n      console.error(\"SocketManager не инициализирован.\");\r\n      return;\r\n    }\r\n\r\n    const userId = SocketManager.instance.getUserId();\r\n    console.log(\"User ID:\", userId);\r\n\r\n    if (!userId) {\r\n      console.error(\"userId не установлен в SocketManager.\");\r\n      return;\r\n    }\r\n\r\n    this.referralLink = `https://t.me/misapatStage_bot?startapp=refId${userId}`;\r\n    if (this.referralLinkLabel) {\r\n      this.referralLinkLabel.string = this.referralLink;\r\n    }\r\n    console.log(`Реферальная ссылка создана: ${this.referralLink}`);\r\n  }\r\n\r\n  onGenerateLinkClicked() {\r\n    console.log(\"onGenerateLinkClicked called\");\r\n    this.generateReferralLink();\r\n  }\r\n\r\n  async onCopyLinkClicked() {\r\n    console.log(\"onCopyLinkClicked called\");\r\n    if (this.copyNotificationLabel) {\r\n      this.copyNotificationLabel.node.active = true;\r\n      this.copyNotificationLabel.color = new Color(255, 255, 255, 255);\r\n      this.copyNotificationLabel.node.setPosition(this.initialPosition.clone());\r\n\r\n      tween(this.copyNotificationLabel)\r\n        .to(this.animationDuration, { color: new Color(255, 255, 255, 0) })\r\n        .start();\r\n\r\n      tween(this.copyNotificationLabel.node)\r\n        .by(this.animationDuration, {\r\n          position: new Vec3(0, this.moveUpDistance, 0),\r\n        })\r\n        .call(() => {\r\n          this.copyNotificationLabel.node.active = false;\r\n          this.copyNotificationLabel.color = new Color(255, 255, 255, 255);\r\n          this.copyNotificationLabel.node.setPosition(\r\n            this.initialPosition.clone()\r\n          );\r\n        })\r\n        .start();\r\n    }\r\n\r\n    if (!this.referralLink) {\r\n      console.warn(\"Реферальная ссылка не создана.\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      await navigator.clipboard.writeText(this.referralLink);\r\n      console.log(\"Реферальная ссылка скопирована в буфер обмена.\");\r\n    } catch (err) {\r\n      console.error(\"Не удалось скопировать ссылку: \", err);\r\n    }\r\n  }\r\n\r\n  onInviteFriendClicked() {\r\n    console.log(\"onInviteFriendClicked called\");\r\n    if (!this.referralLink) {\r\n      console.warn(\"Реферальная ссылка не создана.\");\r\n      return;\r\n    }\r\n    console.log(\"Открываем ссылку:\", this.referralLink);\r\n\r\n    const tg = (window as any).Telegram?.WebApp;\r\n    if (tg && tg.openTelegramLink) {\r\n      console.log(\"Используем tg.openTelegramLink для открытия ссылки\");\r\n      tg.openTelegramLink(this.referralLink);\r\n    } else {\r\n      console.log(\"Используем sys.openURL для открытия ссылки\");\r\n      sys.openURL(this.referralLink);\r\n    }\r\n  }\r\n}\r\n"]}